# file: app.py
import gradio as gr
import torch
from diffusers import StableDiffusionPipeline
from pathlib import Path
import subprocess
import os

# Set device
device = "cuda" if torch.cuda.is_available() else "cpu"

# Load Stable Diffusion model for images
pipe = StableDiffusionPipeline.from_pretrained(
    "runwayml/stable-diffusion-v1-5",
    torch_dtype=torch.float16
).to(device)

# Directory to save outputs
Path("outputs/images").mkdir(parents=True, exist_ok=True)
Path("outputs/videos").mkdir(parents=True, exist_ok=True)

def generate_image(prompt):
    image = pipe(prompt, height=1080, width=1920).images[0]
    file_path = f"outputs/images/{prompt.replace(' ','_')}.png"
    image.save(file_path)
    return file_path

def generate_video(prompt, frames: int = 30):
    # Generate frames
    frame_folder = Path(f"outputs/videos/{prompt.replace(' ','_')}_frames")
    frame_folder.mkdir(parents=True, exist_ok=True)
    for i in range(frames):
        img = pipe(f"{prompt}, frame {i}", height=1080, width=1920).images[0]
        img.save(frame_folder / f"frame_{i:04d}.png")
    
    # Stitch frames into video
    video_path = f"outputs/videos/{prompt.replace(' ','_')}.mp4"
    subprocess.run([
        "ffmpeg", "-y",
        "-r", "30",
        "-i", f"{frame_folder}/frame_%04d.png",
        "-c:v", "libx264",
        "-pix_fmt", "yuv420p",
        video_path
    ])
    return video_path

# Gradio interface
with gr.Blocks() as demo:
    gr.Markdown("# AI Image & Video Generator (1080p)")

    with gr.Tab("Generate Image"):
        img_prompt = gr.Textbox(label="Prompt")
        img_out = gr.Image()
        btn_img = gr.Button("Generate Image")
        btn_img.click(generate_image, inputs=img_prompt, outputs=img_out)

    with gr.Tab("Generate Video"):
        vid_prompt = gr.Textbox(label="Prompt")
        vid_frames = gr.Slider(10, 60, step=1, label="Number of Frames")
        vid_out = gr.Video()
        btn_vid = gr.Button("Generate Video")
        btn_vid.click(generate_video, inputs=[vid_prompt, vid_frames], outputs=vid_out)

demo.launch(server_name="0.0.0.0", server_port=7860)
